# Vistora 项目级方案（质量优先 / 投稿导向）

## 1. 文档目标

这个文档定义 Vistora 在下一阶段的核心策略：

1. 先把视觉质量做到可复现的强结果（速度暂时让位）。
2. 采用更新架构（Transformer / Foundation Model / Diffusion 辅助）提升学术新颖性。
3. 在质量稳定后，再进入系统效率优化和产品化放量。

## 2. 成功标准（质量阶段）

### 2.1 质量主指标

- `LPIPS` 明显下降（越低越好）
- `DISTS` 明显下降（越低越好）
- `SSIM` / `PSNR` 稳定提升
- `tOF` / `tLPIPS`（时序一致性）改善
- 人评 `MOS` 提升（至少双盲小样本）

### 2.2 工程主标准

- 每个实验配置可复现（固定数据切分、随机种子、命令行）
- 每个阶段可独立替换模型（detector/restorer/refiner 解耦）
- 每次模型升级都有消融对比表，不只给“主观感觉”

## 3. 三套模型路线（先质量，后效率）

## 3.1 方案 A：分割优先 + 视频恢复主干（推荐）

定位：风险可控、质量上限高、最适合先做出强基线并投稿。

### 检测与掩码（Stage-1）

- 主检测器：`RT-DETRv2` 或同级 Transformer 检测器
- 精细分割：`Mask2Former`（边界质量优于纯框检测）
- 掩码修补：`SAM2` 作为候选精修器（离线伪标注 + 在线后处理）
- 时序跟踪：`DeAOT/XMem` 一类视频对象跟踪模块，用于掩码跨帧稳定

### 恢复主干（Stage-2）

- 主恢复器：`RVRT` / `VRT`（优先作为 high/ultra 档核心）
- 稳定 baseline：`BasicVSR++`（作为回退和对照）

### 细节精修（Stage-3）

- 轻量精修：`SwinIR` 风格 refiner
- 重量精修：扩散式 refiner（仅 ultra 档，用于感知质量上限）

### 推荐原因

- 组件可替换，消融实验自然成立
- Transformer + Foundation Model 组合有足够“新模型”属性
- 先把质量做强，再做 TensorRT/ONNX 加速不会破坏论文主线

## 3.2 方案 B：Foundation Model 主导（高潜力，高风险）

定位：学术叙事新，但工程复杂度和训练/调参成本高。

- 采用 Grounded detection + promptable segmentation 作为统一感知层
- 通过统一视觉特征引导视频恢复器
- 重度依赖高质量数据标注与 prompt 工程

主要风险：

- 可复现难度高
- 工程依赖重，迭代周期长
- 短期可能不如方案 A 稳定产出结果

## 3.3 方案 C：生成式端到端增强（上限最高，论文风险最高）

定位：追求最强主观视觉效果，但最容易出现“看起来好、指标不稳”。

- 生成式视频增强作为主恢复
- 显式时序约束与身份一致性约束并行
- 需要严格防止 hallucination 和跨帧闪烁

主要风险：

- 客观指标与主观指标可能背离
- 训练资源占用大
- 产品落地可控性较弱

## 3.4 路线选择结论

- 当前默认执行：**方案 A**
- 方案 B/C 作为论文扩展分支，不作为第一里程碑阻塞项

## 4. 数据与训练策略（质量导向）

## 4.1 数据策略

- 合规前提：仅使用有授权的数据，保留来源记录
- 建立合成 mosaic 管线：
  - 尺寸、形状、强度、压缩噪声、运动模糊随机化
  - 单帧与长视频片段混合
- 构建 hard-case 子集：
  - 快速运动
  - 光照突变
  - 严重压缩和低码率

## 4.2 训练策略

- Curriculum：
  1. 先训练检测/分割精度
  2. 再训练恢复主干
  3. 最后联调 refiner 与时序一致性
- 关键 loss 组合：
  - 重建损失（L1/L2）
  - 感知损失（LPIPS 类）
  - 时序一致性损失（光流或特征对齐）
  - 可选对抗损失（仅在稳定后引入）

## 5. 论文友好的实验设计

## 5.1 最小可投稿实验包

1. Baseline：`YOLO/BasicVSR++`（当前稳定管线）
2. 方案 A 主配置：`Transformer detector + RVRT/VRT + refiner`
3. 消融：
   - detector 替换
   - restorer 替换
   - refiner on/off
   - 掩码跟踪 on/off
4. 报告：
   - 指标均值、标准差、95% CI
   - 参数量、推理时延、显存峰值
   - 典型失败案例分析

## 5.2 投稿叙事建议

- 核心贡献不写“单点模型提升”，而写“**质量优先的可部署视频恢复系统方法学**”
- 强调：
  - 分阶段模型组合如何系统性提升质量
  - 为什么这种组合在真实部署链路中可复现
  - 如何平衡学术指标与产品约束（积分、任务队列、可运营）

## 6. 与当前仓库的映射改造

## 6.1 模型目录层

- 扩展 `vistora/services/model_catalog.py`
- 为每个 tier 提供：
  - 默认 detector/restorer/refiner
  - 可选替换集合
  - 模型说明（质量收益、已知风险）

## 6.2 运行层

- 在 `vistora/services/runners.py` 增加真实 backend runner：
  - `onnxruntime-quality`
  - `trt-quality`（后续效率阶段启用）
  - `torch-eager-quality`（研究调参优先）

## 6.3 实验层

- 在 `experiments/` 增加：
  - `configs/`（统一实验 YAML）
  - `scripts/`（一键跑全套消融）
  - `reports/`（自动生成表格与图）

## 7. 里程碑（质量优先）

## M1（1-2 周）：强基线建立

- 交付：
  - 方案 A 的首个可运行版本
  - 第一版质量对比表（至少 3 个指标）
  - 可视化案例集（好/坏样例都保留）

## M2（2-4 周）：稳定提升与消融

- 交付：
  - detector/restorer/refiner 三组消融完整结果
  - 时序一致性专项评估
  - 论文图表草稿 v1

## M3（4-6 周）：论文准备

- 交付：
  - 实验重复 3 次以上的统计报告
  - 方法章节和实验章节初稿
  - 开源仓库可复现实验说明

## M4（后续）：效率与产品化增强

- 在质量冻结后再进入：
  - 显存利用优化
  - 推理吞吐优化
  - Telegram 运营链路放量

## 8. 风险与边界

- 法务与合规：数据来源、用途边界、审计日志必须明确
- 学术风险：只谈实证结果，不做超出证据的泛化结论
- 工程风险：生成式模块必须受控，禁止无约束 hallucination

## 9. 立即执行清单（本周）

1. 在 `model_catalog` 中将方案 A 设为 `high` 的正式默认。
2. 新建 `experiments/configs/quality_first_v1.yaml`。
3. 增加统一评测脚本，固定数据切分与随机种子。
4. 先提交一版“质量结果优先”对比表，再讨论任何速度优化。
